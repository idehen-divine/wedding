name: Deploy Laravel App

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ“¤ Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            echo "ðŸ“‚ Navigating to project directory"
            cd /home/lonely/wedding/wedding

            echo "âš™ï¸ Setting up environment file"
            if [ -f "/home/lonely/wedding/wedding.env" ]; then
              cp /home/lonely/wedding/wedding.env .env
            else
              cp .env.example .env
              sed -i "s|^APP_NAME=.*|APP_NAME=\"Wedding\"|" .env
              sed -i "s|^APP_ENV=.*|APP_ENV=production|" .env
              sed -i "s|^APP_URL=.*|APP_URL=http://www.preshlin25.com|" .env
              sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=sqlite|" .env
              cp .env /home/lonely/wedding/wedding.env
            fi

            echo "ðŸ—„ï¸ Setting up SQLite database"
            if [ -f "/home/lonely/wedding/weddingdatabase.sqlite" ]; then
              cp /home/lonely/wedding/weddingdatabase.sqlite database/database.sqlite
            else
              touch database/database.sqlite
              cp database/database.sqlite /home/lonely/wedding/weddingdatabase.sqlite
            fi

            echo "ðŸ“¦ Installing PHP dependencies"
            composer install --optimize-autoloader --no-dev --no-interaction

            echo "ðŸ”‘ Generating app key"
            php artisan key:generate --force

            echo "ðŸ—ƒï¸ Running database migrations"
            php artisan migrate --force

            echo "ðŸ§¹ Optimizing application"
            php artisan optimize

            echo "ðŸ”’ Setting permissions"
            chown -R www-data:www-data /home/lonely/wedding/wedding
            chmod -R 755 /home/lonely/wedding/wedding
            chmod -R 775 /home/lonely/wedding/wedding/storage /home/lonely/wedding/wedding/bootstrap/cache
            chmod 644 /home/lonely/wedding/wedding/database/database.sqlite

            echo "âœ… Deployment finished"
          EOF
